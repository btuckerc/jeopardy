generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector]
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                  String         @id @default(cuid())
  name                String?
  email               String?        @unique
  emailVerified       DateTime?
  image               String?
  displayName         String?
  selectedIcon        String?
  avatarBackground    String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  role                UserRole       @default(USER)
  lastSpoilerPrompt   DateTime?
  spoilerBlockDate    DateTime?
  spoilerBlockEnabled Boolean        @default(false)
  accounts            Account[]
  sessions            Session[]
  games               Game[]
  gameHistory         GameHistory[]
  userProgress        UserProgress[]
}

model Question {
  id                String                         @id @default(uuid())
  question          String
  answer            String
  value             Int
  difficulty        Difficulty
  categoryId        String
  knowledgeCategory KnowledgeCategory
  airDate           DateTime?
  season            Int?
  episodeId         String?
  createdAt         DateTime                       @default(now())
  updatedAt         DateTime                       @updatedAt
  wasTripleStumper  Boolean                        @default(false)
  isDoubleJeopardy  Boolean                        @default(false) // @deprecated - use 'round' instead
  round             JeopardyRound                  @default(SINGLE)
  embedding         Unsupported("vector(1536)")?
  gameHistory       GameHistory[]
  games             GameQuestion[]
  category          Category                       @relation(fields: [categoryId], references: [id])
  userProgress      UserProgress[]
  tags              Tag[]                          @relation("QuestionTags")

  @@index([categoryId])
  @@index([knowledgeCategory])
  @@index([airDate])
  @@index([round])
}

model Category {
  id                String                         @id @default(uuid())
  name              String                         @unique
  knowledgeCategory KnowledgeCategory?
  embedding         Unsupported("vector(1536)")?
  createdAt         DateTime                       @default(now())
  updatedAt         DateTime                       @updatedAt
  questions         Question[]
  userProgress      UserProgress[]

  @@index([knowledgeCategory])
}

model Tag {
  id        String     @id @default(uuid())
  name      String     @unique
  questions Question[] @relation("QuestionTags")
}

model KnowledgeCategoryEmbedding {
  id                String                       @id @default(uuid())
  knowledgeCategory KnowledgeCategory            @unique
  description       String
  embedding         Unsupported("vector(1536)")
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
}

model GameHistory {
  id         String   @id @default(uuid())
  userId     String
  questionId String
  correct    Boolean
  points     Int      @default(0)
  timestamp  DateTime @default(now())
  question   Question @relation(fields: [questionId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model UserProgress {
  id         String   @id @default(uuid())
  userId     String
  categoryId String
  questionId String
  correct    Int      @default(0)
  total      Int      @default(0)
  points     Int      @default(0)
  category   Category @relation(fields: [categoryId], references: [id])
  question   Question @relation(fields: [questionId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, categoryId])
}

model Game {
  id                     String         @id @default(uuid())
  userId                 String
  useKnowledgeCategories Boolean        @default(false)
  score                  Int            @default(0)
  completed              Boolean        @default(false)
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  
  // New fields for resumable games and multiplayer support
  seed                   String?        @unique // Short opaque identifier for sharing/recreating games
  config                 Json?          // Full game configuration (mode, categories, rounds, etc.)
  status                 GameStatus     @default(IN_PROGRESS)
  currentRound           JeopardyRound  @default(SINGLE)
  currentScore           Int            @default(0) // Tracks score during gameplay (separate from final score)
  visibility             GameVisibility @default(PRIVATE)
  
  // Multiplayer-ready fields (nullable for now)
  opponentUserId         String?        // For future 2-player games
  
  user                   User           @relation(fields: [userId], references: [id])
  questions              GameQuestion[]

  @@index([userId, status])
  @@index([seed])
}

model GameQuestion {
  id         String   @id @default(uuid())
  gameId     String
  questionId String
  answered   Boolean  @default(false)
  correct    Boolean?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  game       Game     @relation(fields: [gameId], references: [id])
  question   Question @relation(fields: [questionId], references: [id])

  @@unique([gameId, questionId])
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum JeopardyRound {
  SINGLE
  DOUBLE
  FINAL
}

enum UserRole {
  USER
  ADMIN
}

enum KnowledgeCategory {
  GEOGRAPHY_AND_HISTORY
  ENTERTAINMENT
  ARTS_AND_LITERATURE
  SCIENCE_AND_NATURE
  SPORTS_AND_LEISURE
  GENERAL_KNOWLEDGE
}

enum GameStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum GameVisibility {
  PRIVATE
  UNLISTED
  PUBLIC
}
