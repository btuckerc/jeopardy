FROM node:20

WORKDIR /app

# Install system dependencies Prisma expects (OpenSSL, ca-certificates)
RUN apt-get update \
  && apt-get install -y --no-install-recommends openssl ca-certificates \
  && rm -rf /var/lib/apt/lists/*

# Copy package files first
COPY package*.json ./

# Copy Prisma schema BEFORE npm ci (prepare script needs it)
COPY prisma ./prisma

# Copy entrypoint script
COPY scripts/docker-entrypoint.js ./scripts/docker-entrypoint.js
RUN chmod +x ./scripts/docker-entrypoint.js

# Install dependencies (prepare script will run db:generate automatically)
RUN npm ci

# Build args for Next.js public env vars (must be available at build time)
ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY

ENV NODE_ENV=development
ENV PORT=3000

EXPOSE 3000

# Use entrypoint script to run migrations before starting
ENTRYPOINT ["node", "scripts/docker-entrypoint.js"]
CMD ["npm", "run", "dev"]

